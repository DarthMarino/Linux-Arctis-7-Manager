app-id: io.github.DarthMarino.ArctisManager
runtime: org.kde.Platform
runtime-version: '6.7'
sdk: org.kde.Sdk
command: arctis-manager-launcher
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --socket=pulseaudio
  - --device=all  # Required for USB device access
  - --filesystem=home/.config/systemd/user:create
  - --talk-name=org.freedesktop.systemd1
  - --system-talk-name=org.freedesktop.systemd1
  - --talk-name=org.pulseaudio.Server
  - --talk-name=org.freedesktop.UDisks2
  
modules:
  - name: python3-dbus-next
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "dbus-next==0.2.3" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/d2/fc/c0a3f4c4eaa5a22fbef91713474666e13d0ea2a69c84532579490a9f2cc8/dbus_next-0.2.3-py3-none-any.whl
        sha256: 58948f9aff9db08316734c0be2a120f6dc502124d9642f55e90ac82ffb16a18b

  - name: python3-pyusb
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "pyusb==1.3.0" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/32/d8/625150e6c2acbbb8eec5aee821f71e8a052ceb6434f55bb2a80a5e385049/pyusb-1.3.0-py3-none-any.whl
        sha256: ca192893cb8cf7df89f4fcf2fea5dc9265a51637459b14635638ea9c13bab765

  - name: python3-qasync
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "qasync==0.27.1" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/51/06/bc628aa2981bcfd452a08ee435b812fd3eee4ada8acb8a76c4a09d1a5a77/qasync-0.27.1-py3-none-any.whl
        sha256: 5d57335723bc7d9b328dadd8cb2ed7978640e4bf2da184889ce50ee3ad2602c7

  - name: arctis-manager
    buildsystem: simple
    build-commands:
      - python3 -m pip install --no-deps --prefix=${FLATPAK_DEST} -e .
      - install -Dm644 ArctisManager.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm644 arctis_manager/images/steelseries_logo.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm644 systemd/arctis-manager.service ${FLATPAK_DEST}/share/systemd/user/arctis-manager.service
      - install -Dm644 systemd/arctis-manager.path ${FLATPAK_DEST}/share/systemd/user/arctis-manager.path
      - install -Dm644 systemd/arctis-manager-restart.service ${FLATPAK_DEST}/share/systemd/user/arctis-manager-restart.service
      # Create wrapper script for launcher
      - |
        cat > ${FLATPAK_DEST}/bin/arctis-manager-launcher << 'EOF'
        #!/bin/bash
        # Flatpak wrapper for Arctis Manager
        export PYTHONPATH="${FLATPAK_DEST}/lib/python3.11/site-packages:${PYTHONPATH}"
        exec python3 ${FLATPAK_DEST}/lib/python3.11/site-packages/arctis_manager_launcher.py "$@"
        EOF
      - chmod +x ${FLATPAK_DEST}/bin/arctis-manager-launcher
    sources:
      - type: git
        url: https://github.com/DarthMarino/Linux-Arctis-7-Manager.git
        branch: main